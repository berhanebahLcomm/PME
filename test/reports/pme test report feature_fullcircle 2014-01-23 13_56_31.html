<!DOCTYPE html>
<html>
<head>
<meta charset="utf8">
<title>PME Translator TestCase Result of 2014-01-23 13:56:31 (feature/fullcircle/25b13b2)</title>
<style>
	body {
		width: 960px;
		margin: 0 auto;
	}
	header {
		padding: 1em 0 2em 0;
	}
	h1, h2, h3, p {
		margin: 0;
		padding: 0 0 .4em 0;
	}
	ul {
		list-style: none;
		padding: 0;
		margin: 0;
	}
	ul.testcases {
		padding-left: 2em;
	}
	ul.testcases li {
		margin-bottom: 1em;
	}
	.translator {
		padding: 1em 0;
		border-bottom: 1px solid #999;
	}
	.translator.no-tests {
		background-color: orange;
	}
	.testcase.error {
		background-color: #faa;
	}

	/* nice emoji */
	.translator.success h1:before,
	.testcase.success a:before {
		content: "\2705  ";
	}
	p.fatal:before,
	.translator.error h1:before,
	.testcase.error a:before {
		content: "\274c  ";
	}

	/* crap unicode */
	.cr .translator.success h1:before,
	.cr .testcase.success a:before {
		content: "\2714  ";
	}
	.cr p.fatal:before,
	.cr .translator.error h1:before,
	.cr .testcase.error a:before {
		content: "\2716  ";
	}
</style>


<!-- testResults array is inserted here by the test driver, it contains all of the output for all tests -->
<script>
const testResults = [{"translator":"BibTeX.js","testCaseResults":[],"errorMessage":null,"stdout":"PME_TEST requested translator: BibTeX.js\nPME_TEST translator file loaded in server context\nPME_TEST no (applicable) testcases for this translator\nPME_TEST didCompleteTestCases\n{\"translator\":\"BibTeX.js\",\"testCaseResults\":[],\"errorMessage\":null}\n","stderr":""},{"translator":"COinS.js","testCaseResults":[{"url":"http://www.husdal.com/2011/06/19/disruptions-in-supply-networks/","success":false,"errors":["error loading testcase page"]},{"url":"http://www.hubmed.org/display.cgi?uids=21665052","success":false,"errors":["translator returned empty resultset"]}],"errorMessage":null,"stdout":"PME_TEST requested translator: COinS.js\nPME_TEST translator file loaded in server context\nPME_TEST TESTCASE_LIMIT was set, limiting to 2 testCase(s)\nPME_TEST runNextTestCase\nPME_TEST runTestCase http://www.husdal.com/2011/06/19/disruptions-in-supply-networks/\nPME_TEST runNextTestCase\nPME_TEST runTestCase http://www.hubmed.org/display.cgi?uids=21665052\nPME_TEST client page loaded\nPME_TEST inserting PME using PME_SRV = localhost:8082\nPME_TEST waiting for resultset\nPME_TEST found resultset\nPME_TEST runNextTestCase\nPME_TEST all testcases done\nPME_TEST didCompleteTestCases\n{\"translator\":\"COinS.js\",\"testCaseResults\":[{\"url\":\"http://www.husdal.com/2011/06/19/disruptions-in-supply-networks/\",\"success\":false,\"errors\":[\"error loading testcase page\"]},{\"url\":\"http://www.hubmed.org/display.cgi?uids=21665052\",\"success\":false,\"errors\":[\"translator returned empty resultset\"]}],\"errorMessage\":null}\n","stderr":""},{"translator":"DOAJ.js","testCaseResults":[],"errorMessage":null,"stdout":"PME_TEST requested translator: DOAJ.js\nPME_TEST translator file loaded in server context\nPME_TEST no (applicable) testcases for this translator\nPME_TEST didCompleteTestCases\n{\"translator\":\"DOAJ.js\",\"testCaseResults\":[],\"errorMessage\":null}\n","stderr":""},{"translator":"EBSCOHost.js","testCaseResults":[{"url":"http://search.ebscohost.com/login.aspx?direct=true&db=aph&AN=9606204477&site=ehost-live","success":false,"errors":["translator returned empty resultset"]}],"errorMessage":null,"stdout":"PME_TEST requested translator: EBSCOHost.js\nPME_TEST translator file loaded in server context\nPME_TEST TESTCASE_LIMIT was set, limiting to 2 testCase(s)\nPME_TEST runNextTestCase\nPME_TEST runTestCase http://search.ebscohost.com/login.aspx?direct=true&db=aph&AN=9606204477&site=ehost-live\nPME_TEST client page loaded\nPME_TEST inserting PME using PME_SRV = localhost:8082\nPME_TEST waiting for resultset\nPME_TEST found resultset\nPME_TEST runNextTestCase\nPME_TEST all testcases done\nPME_TEST didCompleteTestCases\n{\"translator\":\"EBSCOHost.js\",\"testCaseResults\":[{\"url\":\"http://search.ebscohost.com/login.aspx?direct=true&db=aph&AN=9606204477&site=ehost-live\",\"success\":false,\"errors\":[\"translator returned empty resultset\"]}],\"errorMessage\":null}\n","stderr":""},{"translator":"Embedded Metadata.js","testCaseResults":[{"url":"http://tools.chass.ncsu.edu/open_journal/index.php/acontracorriente/article/view/174","success":false,"errors":["translator returned empty resultset"]},{"url":"http://www.ajol.info/index.php/thrb/article/view/63347","success":false,"errors":["translator returned empty resultset"]}],"errorMessage":null,"stdout":"PME_TEST requested translator: Embedded Metadata.js\nPME_TEST translator file loaded in server context\nPME_TEST TESTCASE_LIMIT was set, limiting to 2 testCase(s)\nPME_TEST runNextTestCase\nPME_TEST runTestCase http://tools.chass.ncsu.edu/open_journal/index.php/acontracorriente/article/view/174\nPME_TEST client page loaded\nPME_TEST inserting PME using PME_SRV = localhost:8082\nPME_TEST waiting for resultset\nPME_TEST found resultset\nPME_TEST runNextTestCase\nPME_TEST runTestCase http://www.ajol.info/index.php/thrb/article/view/63347\nPME_TEST client page loaded\nPME_TEST inserting PME using PME_SRV = localhost:8082\nPME_TEST waiting for resultset\nPME_TEST found resultset\nPME_TEST runNextTestCase\nPME_TEST all testcases done\nPME_TEST didCompleteTestCases\n{\"translator\":\"Embedded Metadata.js\",\"testCaseResults\":[{\"url\":\"http://tools.chass.ncsu.edu/open_journal/index.php/acontracorriente/article/view/174\",\"success\":false,\"errors\":[\"translator returned empty resultset\"]},{\"url\":\"http://www.ajol.info/index.php/thrb/article/view/63347\",\"success\":false,\"errors\":[\"translator returned empty resultset\"]}],\"errorMessage\":null}\n","stderr":""},{"translator":"Financial Times.js","testCaseResults":[{"url":"http://blogs.ft.com/beyond-brics/2012/01/02/12-for-2012-brazils-import-substitution-2-0/#axzz1iLZdoFBr","success":false,"errors":["translator returned empty resultset"]},{"url":"http://www.ft.com/intl/cms/s/2/0d506e0e-1583-11e1-b9b8-00144feabdc0.html#axzz1hzl2SwPD","success":false,"errors":["did not find resultset after 10s"]}],"errorMessage":null,"stdout":"PME_TEST requested translator: Financial Times.js\nPME_TEST translator file loaded in server context\nPME_TEST TESTCASE_LIMIT was set, limiting to 2 testCase(s)\nPME_TEST runNextTestCase\nPME_TEST runTestCase http://blogs.ft.com/beyond-brics/2012/01/02/12-for-2012-brazils-import-substitution-2-0/#axzz1iLZdoFBr\nTypeError: 'undefined' is not an object (evaluating 'FT.isPage.Site')\n\n  http://s2.media.ft.com/scripts/2029995712/bundles/foot.js:203\n  http://s2.media.ft.com/scripts/N913297001/bundles/head.js:2\n  http://s2.media.ft.com/scripts/N913297001/bundles/head.js:2\n  http://s2.media.ft.com/scripts/N913297001/bundles/head.js:2\n  http://s2.media.ft.com/scripts/N913297001/bundles/head.js:2\nPME_TEST client page loaded\nPME_TEST inserting PME using PME_SRV = localhost:8082\nPME_TEST waiting for resultset\nPME_TEST found resultset\nPME_TEST runNextTestCase\nPME_TEST runTestCase http://www.ft.com/intl/cms/s/2/0d506e0e-1583-11e1-b9b8-00144feabdc0.html#axzz1hzl2SwPD\nPME_TEST client page loaded\nPME_TEST inserting PME using PME_SRV = localhost:8082\nPME_TEST waiting for resultset\nPME_TEST runNextTestCase\nPME_TEST all testcases done\nPME_TEST didCompleteTestCases\n{\"translator\":\"Financial Times.js\",\"testCaseResults\":[{\"url\":\"http://blogs.ft.com/beyond-brics/2012/01/02/12-for-2012-brazils-import-substitution-2-0/#axzz1iLZdoFBr\",\"success\":false,\"errors\":[\"translator returned empty resultset\"]},{\"url\":\"http://www.ft.com/intl/cms/s/2/0d506e0e-1583-11e1-b9b8-00144feabdc0.html#axzz1hzl2SwPD\",\"success\":false,\"errors\":[\"did not find resultset after 10s\"]}],\"errorMessage\":null}\n","stderr":""}];
</script>


<script>
// constants
const CLONE_DEEP = true; // used in node.cloneNode() calls to clarify meaning of the single bool parameter


// some convenience functions used in this page
function $(sel, base) {
	return (base || document).querySelector(sel);
}

function removeNode(node) {
	node.parentNode.removeChild(node);
}

function flatten(arr) {
	var q = [];
	arr.forEach(function(k) {
		q = q.concat(k);
	});
	return q;
}

function appendAsListItem(item, list) {
	var li = document.createElement("li");
	if (typeof item == "string")
		li.textContent = item;
	else
		li.appendChild(item);
	list.appendChild(li);
}


// Use a TreeWalker to iterate over all text and element nodes and replace
// placholder tokens of the form {{token}} with the contents of the named
// fields in the passed data object.
function replacePlaceholders(fields, template) {
	var out = template.cloneNode(CLONE_DEEP),
		walker = document.createTreeWalker(out, NodeFilter.SHOW_TEXT | NodeFilter.SHOW_ELEMENT),
		placeholder = /\{\{([a-zA-Z\-_0-9]+)\}\}/g,
		replaceWithField = function(_, field) {
			return fields[field] || ("Â¿" + field + "?");
		};

	while (walker.nextNode()) {
		var node = walker.currentNode;

		if (node.nodeType == document.TEXT_NODE) {
			// for text nodes, update their textContent value
			node.textContent = node.textContent.replace(placeholder, replaceWithField);
		}
		else if (node.nodeType == document.ELEMENT_NODE) {
			// for elements, update their attributes' values
			for (var atix = 0; atix < node.attributes.length; ++atix)
				node.attributes[atix].value = node.attributes[atix].value.replace(placeholder, replaceWithField);
		}
	}

	return out;
}


// Clone a specified node from base, anonimize it and remove it
// from its original context. Returned node can be used as a template.
function extractTemplateNode(sel, base) {
	var tmplNode = $(sel, base),
		template = tmplNode.cloneNode(CLONE_DEEP);

	removeNode(tmplNode);
	template.id = null;	
	return template;
}


function translatorTestWasSuccessful(test) {
	var anyTestCaseErrors = test.testCaseResults.some(function(tc) {
		return !tc.success;
	});
	return ! (test.errorMessage || anyTestCaseErrors);
}


// Main page creation driver. testResults is defined above (inserted
// by the test driver script). testResults is an array of translator
// tests, which contain arrays of test cases, which contain arrays
// of error strings and other associated metadata.
// Values are replaced in text and some basic dom manipilation is done
// to add classes, hide unused elements etc.
window.onload = function main() {
	// chrome no know nice looking emoji, likely win will neither, but eh
	if (navigator.userAgent.indexOf("Chrome/") > -1)
		document.body.className = "cr";

	var translatorTemplate = extractTemplateNode("#translator-template"),
		testCaseTemplate = extractTemplateNode("#testcase-template", translatorTemplate),
		testList = $("ul.translators");

	// iterate over the translator tests
	testResults.forEach(function(translatorResult) {
		var trans = replacePlaceholders(translatorResult, translatorTemplate),
			testCaseList = $("ul.testcases", trans);

		// remove fatal error node if there was no error
		if (! translatorResult.errorMessage)
			removeNode($("p.fatal", trans));

		// full-test status as css class
		if (translatorTestWasSuccessful(translatorResult)) {
			if (translatorResult.testCaseResults.length)
				trans.className += " success";
			else
				trans.className += " no-tests";
		}
		else
			trans.className += " error";

		// iterate over testcases
		translatorResult.testCaseResults.forEach(function(testCase) {
			var tc = replacePlaceholders(testCase, testCaseTemplate),
				errors = flatten(testCase.errors),
				errorList = $("ul.errors", tc);

			// single testcase status as css class
			if (! errors.length)
				tc.className += " success";
			else
				tc.className += " error";

			errors.forEach(function(errText) {
				appendAsListItem(errText, errorList);
			});

			appendAsListItem(tc, testCaseList);
		});

		appendAsListItem(trans, testList);
	});
};
</script>
</head>


<body>
	<!-- the %% enclosed values are replaced by the test driver script -->
	<header>
		<h1>PME Test Result of 2014-01-23 13:56:31</h1>
		<h2>Using Git branch: feature/fullcircle, revision: 25b13b2</h2>
	</header>

	<!-- transformed test result templates are inserted here -->
	<ul class="translators"></ul>

	<!-- this is the 3-layer deep template for all test results -->
	<section class="translator" id="translator-template">
		<h1>{{translator}}</h1>
		<p class="fatal">{{errorMessage}}</p>

		<ul class="testcases"></ul>

		<div class="testcase" id="testcase-template">
			<p><a href="{{url}}">{{url}}</a></p>
			<ul class="errors"></ul>
		</div>
	</section>
</body>
</html>
