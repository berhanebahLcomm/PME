<!DOCTYPE html>
<html>
<head>
<meta charset="utf8">
<title>PME Translator TestCase Result of %%DATETIME%% (%%GIT_BRANCH%%/%%GIT_REVISION%%)</title>
<style>
	ul { list-style: none; }
</style>


<!-- testResults array is inserted here by the test driver, it contains all of the output for all tests -->
<script>
const testResults = %%RESULT_JSON%%;
</script>


<script>
// constants
const CLONE_DEEP = true; // used in node.cloneNode() calls to clarify meaning of the single bool parameter


// some convenience functions used in this page
function $(sel, base) {
	return (base || document).querySelector(sel);
}

function flatten(arr) {
	var q = [];
	arr.forEach(function(k) {
		q = q.concat(k);
	});
	return q;
}

function appendAsListItem(item, list) {
	var li = document.createElement("li");
	if (typeof item == "string")
		li.textContent = item;
	else
		li.appendChild(item);
	list.appendChild(li);
}


// Use a TreeWalker to iterate over all text and element nodes and replace
// placholder tokens of the form {{token}} with the contents of the named
// fields in the passed data object.
function replacePlaceholders(fields, template) {
	var out = template.cloneNode(CLONE_DEEP),
		walker = document.createTreeWalker(out, NodeFilter.SHOW_TEXT | NodeFilter.SHOW_ELEMENT),
		placeholder = /\{\{([a-zA-Z\-_0-9]+)\}\}/g,
		replaceWithField = function(_, field) {
			return fields[field] || ("Â¿" + field + "?");
		};

	while (walker.nextNode()) {
		var node = walker.currentNode;

		if (node.nodeType == document.TEXT_NODE) {
			// for text nodes, update their textContent value
			node.textContent = node.textContent.replace(placeholder, replaceWithField);
		}
		else if (node.nodeType == document.ELEMENT_NODE) {
			// for elements, update their attributes' values
			for (var atix = 0; atix < node.attributes.length; ++atix)
				node.attributes[atix].value = node.attributes[atix].value.replace(placeholder, replaceWithField);
		}
	}

	return out;
}


// Clone a specified node from base, anonimize it and remove it
// from its original context. Returned node can be used as a template.
function extractTemplateNode(sel, base) {
	var tmplNode = $(sel, base),
		template = tmplNode.cloneNode(CLONE_DEEP);

	tmplNode.parentNode.removeChild(tmplNode);
	template.id = null;	
	return template;
}


// Main page creation driver. testResults is defined above (inserted
// by the test driver script). testResults is an array of translator
// tests, which contain arrays of test cases, which contain arrays
// of error strings and other associated metadata.
// Values are replaced in text and some basic dom manipilation is done
// to add classes, hide unused elements etc.
window.onload = function main() {
	var translatorTemplate = extractTemplateNode("#translator-template"),
		testCaseTemplate = extractTemplateNode("#testcase-template", translatorTemplate),
		testList = $("ul.translators");

	testResults.forEach(function(translatorResult) {
		var trans = replacePlaceholders(translatorResult, translatorTemplate),
			testCaseList = $("ul.testcases", trans);

		translatorResult.testCaseResults.forEach(function(testCase) {
			var tc = replacePlaceholders(testCase, testCaseTemplate),
				errors = flatten(testCase.errors),
				errorList = $("ul.errors", tc);

			errors.forEach(function(errText) {
				appendAsListItem(errText, errorList);
			});

			appendAsListItem(tc, testCaseList);
		});

		appendAsListItem(trans, testList);
	});
};
</script>
</head>


<body>
	<!-- the %% enclosed values are replaced by the test driver script -->
	<header>
		<h1>PME Test Result of %%DATETIME%%</h1>
		<h2>Using Git branch: %%GIT_BRANCH%%, revision: %%GIT_REVISION%%</h2>
	</header>

	<!-- transformed test result templates are inserted here -->
	<ul class="translators"></ul>

	<!-- this is the 3-layer deep template for all test results -->
	<section class="translator" id="translator-template">
		<h1>{{translator}}</h1>
		<p class="fatal">{{errorMessage}}</p>

		<ul class="testcases"></ul>

		<div class="testcase" id="testcase-template">
			<p><a href="{{url}}">{{url}}</a></p>
			<ul class="errors"></ul>
		</div>
	</section>
</body>
</html>
